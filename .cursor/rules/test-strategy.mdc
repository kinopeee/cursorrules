# テスト方針ルール

このルールは、テストコードを実装・改修する際に必ず遵守するテストプロセスを定義する。以下の手順をすべて満たさない限りテストタスクは完了とみなさないこと。

---

## 1. テスト観点表の提示（等価分割・境界値）

1. テスト作業を始める前に、**必ず** Markdown の表形式で「テスト観点の表」を提示する。
2. 表には少なくとも以下の列を含める: `ケースID`, `入力/前提`, `観点 (等価分割/境界値)`, `期待結果`, `備考`。
3. 行には正常系・異常系・境界値を網羅し、境界値は `0 / 最小値 / 最大値 / ±1 / 空 / NULL` を必須で含める。
4. 不足観点が判明した場合は、セルフチェックの上で表を更新し、追加のケースを反映する。

### テンプレート例

| ケースID | 入力/前提           | 観点 (等価分割/境界値) | 期待結果                              | 備考 |
|----------|---------------------|------------------------|----------------------------------------|------|
| TC-N-01  | 正常な入力A         | 等価分割-正常          | 処理が成功し期待値を返す              | -    |
| TC-A-01  | NULL                | 境界値-NULL            | バリデーションエラー(必須項目)        | -    |
| ...      | ...                 | ...                    | ...                                    | ...  |

---

## 2. テストコード実装ポリシー

1. 上記の表に記載したケースを **すべて** 自動化テストとして実装する。
2. **正常系と同数以上の失敗系**（バリデーションエラー、例外、外部依存失敗など）を必ず含める。
3. 以下の観点をテストで網羅する:
   - 正常系（主要シナリオ）
   - 異常系（バリデーションエラー、例外パス）
   - 境界値（0, 最小, 最大, ±1, 空, NULL）
   - 不正な型・形式の入力
   - 外部依存の失敗（API / DB / メッセージング等が該当する場合）
   - 例外種別およびエラーメッセージ
4. さらに、分岐網羅率 100% を目標にし、必要に応じて追加ケースを自ら設計する。

---

## 3. Given / When / Then コメント

各テストケースには必ず以下のコメントフォーマットを付与する。

```text
// Given: 前提条件
// When:  実行する操作
// Then:  期待する結果/検証
```

コメントはテストコード直上またはステップ内に記述し、読み手がシナリオを追えるように保つこと。

---

## 4. 例外・エラー検証

1. 例外が発生するケースでは、例外の**型**と**メッセージ**を明示的に検証する。
2. バリデーション系の異常系では、エラーコードやフィールド情報があれば併せて確認する。
3. 外部依存の失敗を模す場合は、スタブ/モックを利用して期待する例外・リトライ・フォールバックが呼ばれるかを確認する。

---

## 5. 実行コマンドとカバレッジ

1. テスト実装の最後に、**実行コマンド**と**カバレッジ取得方法**をドキュメントやPR本文の末尾に必ず記載する。
   - 例: `npm run test`, `pnpm vitest run --coverage`, `pytest --cov=...`
2. ブランチカバレッジ・ステートメントカバレッジを確認し、最低要件として分岐網羅 100% を目指す。
3. カバレッジレポートの確認結果（スクリーンショットや要約）を可能な範囲で添付する。

---

## 6. 運用上の注意

1. 本ルールに適合しないテストの差分はレビューで差し戻す。
2. 外部依存がない場合でも、失敗系は**モックを活用して擬似的に失敗させる**こと。
3. テスト対象の仕様に新しい分岐や制約が追加された場合、テスト観点表とテストコードを同時に更新する。
4. 自動化が困難なケースがある場合は、理由と代替手段を明記した上でレビューアと合意形成を行う。

---

このルールを遵守し、欠落観点がないか常に自己チェックしたうえでテストを設計・実装すること。
